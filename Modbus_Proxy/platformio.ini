
[env:esp32-c3-base]
; Common settings for both OTA and Serial environments
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
monitor_dtr = 0
monitor_rts = 0
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -std=gnu++17
board_build.usb_cdc = true
board_build.arduino.memory_type = qio_qspi
lib_deps =
    bblanchon/ArduinoJson@^6.19.4
    knolleary/PubSubClient@^2.8
    mathieucarbou/ESP Async WebServer@^3.0.6
    mathieucarbou/AsyncTCP@^3.3.2

; ----------------------------------------------------------------------
; --- ENVIRONMENT 1: SERIAL Upload/Monitor (for initial flash) ---
[env:esp32-c3-serial]
extends = env:esp32-c3-base
; Use the default serial protocol
upload_protocol = esptool
upload_port = COM6
monitor_port = COM6

; ----------------------------------------------------------------------
; --- ENVIRONMENT 2: OTA Upload (for wireless updates) ---
[env:esp32-c3-ota]
extends = env:esp32-c3-base
; Use the network protocol
upload_protocol = espota
upload_port = 192.168.0.177
upload_flags = --auth=modbus_ota_2023
; Monitor port remains COM6 (inherited) for viewing serial logs wirelessly

; ----------------------------------------------------------------------
; --- ENVIRONMENT 3: PRODUCTION Build (no test code, no ArduinoOTA) ---
[env:esp32-c3-production]
extends = env:esp32-c3-base
build_flags =
    ${env:esp32-c3-base.build_flags}
    -DPRODUCTION_BUILD
    -DENABLE_SERIAL_DEBUG=0

; ----------------------------------------------------------------------
; --- ENVIRONMENT 4: NATIVE Unit Tests (host machine, no hardware) ---
[env:native]
platform = native
test_framework = unity
build_flags =
    -std=c++17
    -I test/stubs
    -I src
    -I include
    -DUNIT_TEST
    -DENABLE_SERIAL_DEBUG=0
build_src_filter =
    -<*>
    +<../test/stubs/stubs.cpp>
    +<dtsu666.cpp>
    +<ModbusRTU485.cpp>
    +<nvs_config.cpp>
    +<mqtt_logger.cpp>
lib_deps =
test_build_src = yes